<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IPL Auction Room</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial; background: #f4f4f4; text-align: center; }
    .player-card { border: 1px solid #ccc; padding: 10px; margin: 10px; background: #fff; }
    .bidding-buttons button { margin: 5px; padding: 10px; }
    .summary-table, .bids-log { margin: 20px auto; width: 80%; }
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #ddd; padding: 8px; }
    #timer { font-size: 24px; color: red; margin: 10px 0; }
  </style>
</head>
<body>
  <h2 id="room-name">Room: </h2>
  <div id="player-info" class="player-card"></div>
  <div id="timer">Time Left: 10s</div>

  <div class="bidding-buttons">
    <button onclick="placeBid(0.05)">5L</button>
    <button onclick="placeBid(0.1)">10L</button>
    <button onclick="placeBid(0.25)">25L</button>
    <button onclick="placeBid(0.5)">50L</button>
    <button onclick="placeBid(1)">1Cr</button>
  </div>

  <div id="bids-log" class="bids-log"></div>
  <button id="next-btn" onclick="nextPlayer()" style="display:none;">Next Player</button>

  <h3>Auction Summary</h3>
  <table class="summary-table" id="summary-table">
    <thead><tr><th>Team</th><th>Player</th><th>Price (Cr)</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const room = urlParams.get('room');
    const team = urlParams.get('team');
    let currentBid = 0;
    let highestBidder = null;
    let timeLeft = 10;
    let timerInterval = null;
    let currentPlayer = {};

    document.getElementById("room-name").textContent = "Room: " + room;
    socket.emit("joinRoom", { room, team });

    socket.on("startAuction", player => {
      currentPlayer = player;
      document.getElementById("player-info").innerHTML = `
        <h3>${player.name}</h3>
        <p>Role: ${player.role}</p>
        <p>Base Price: ₹${player.basePrice} Cr</p>
        <p>Current Bid: ₹${currentBid} Cr</p>
      `;
      document.getElementById("bids-log").innerHTML = "";
      currentBid = player.basePrice;
      highestBidder = null;
      timeLeft = 10;
      startTimer();
    });

    function placeBid(amount) {
      currentBid += amount;
      highestBidder = team;
      socket.emit("placeBid", { room, team, amount, total: currentBid });
      document.getElementById("player-info").querySelector("p:last-child").textContent = `Current Bid: ₹${currentBid} Cr`;
    }

    socket.on("newBid", ({ team, amount, total }) => {
      const log = document.getElementById("bids-log");
      const entry = document.createElement("p");
      entry.textContent = `${team} bids ₹${total.toFixed(2)} Cr`;
      log.appendChild(entry);
    });

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").textContent = `Time Left: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          declareWinner();
        }
      }, 1000);
    }

    function declareWinner() {
      const log = document.getElementById("bids-log");
      const winMsg = document.createElement("h4");

      if (highestBidder) {
        winMsg.textContent = `${highestBidder} won ${currentPlayer.name} for ₹${currentBid.toFixed(2)} Cr!`;
        socket.emit("declareWinner", {
          room,
          team: highestBidder,
          player: currentPlayer.name,
          price: currentBid
        });
        addToSummary(highestBidder, currentPlayer.name, currentBid);
      } else {
        winMsg.textContent = `No bids for ${currentPlayer.name}`;
      }
      log.appendChild(winMsg);
      document.getElementById("next-btn").style.display = "inline";
    }

    function addToSummary(team, player, price) {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${team}</td><td>${player}</td><td>₹${price.toFixed(2)} Cr</td>`;
      document.querySelector("#summary-table tbody").appendChild(row);
    }

    function nextPlayer() {
      socket.emit("nextPlayer", room);
      document.getElementById("next-btn").style.display = "none";
    }
  </script>
</body>
</html>
